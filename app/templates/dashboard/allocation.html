{% extends "base.html" %}

{% block title %}Allocation - Epoch Macro{% endblock %}

{% block content %}
{# Asset name mappings #}
{% set asset_names = {
    'QQQ': 'Nasdaq 100',
    'ARKK': 'ARK Innovation',
    'IWM': 'Russell 2000',
    'BTC-USD': 'Bitcoin',
    'XLC': 'Communication Services',
    'XLY': 'Consumer Discretionary',
    'TLT': '20+ Year Treasury',
    'LQD': 'Investment Grade Corporate',
    'ARKX': 'ARK Space Exploration',
    'BOTZ': 'Robotics & AI',
    'XLE': 'Energy Select',
    'DBC': 'Commodities Index',
    'GCC': 'Commodities Strategy',
    'LIT': 'Lithium & Battery',
    'PALL': 'Palladium',
    'VALT': 'Treasury Collateral',
    'XLF': 'Financial Select',
    'XLI': 'Industrial Select',
    'XLB': 'Materials Select',
    'USO': 'US Oil Fund',
    'XOP': 'Oil & Gas E&P',
    'FCG': 'Natural Gas',
    'AA': 'Alcoa',
    'VNQ': 'Real Estate',
    'PAVE': 'Infrastructure',
    'VTV': 'Value ETF',
    'IWD': 'Russell 1000 Value',
    'EEM': 'Emerging Markets',
    'GLD': 'Gold',
    'DBA': 'Agriculture',
    'REMX': 'Rare Earth Metals',
    'URA': 'Uranium',
    'TIP': 'TIPS',
    'VTIP': 'Short-Term TIPS',
    'XLV': 'Health Care Select',
    'XLU': 'Utilities Select',
    'XLP': 'Consumer Staples',
    'VGLT': 'Long-Term Treasury',
    'IEF': '7-10 Year Treasury',
    'MUB': 'Municipal Bonds',
    'SLV': 'Silver'
} %}

{# Asset class categorization #}
{% set asset_categories = {
    'QQQ': 'Equities', 'ARKK': 'Equities', 'IWM': 'Equities', 'XLC': 'Equities', 'XLY': 'Equities',
    'XLV': 'Equities', 'XLU': 'Equities', 'XLP': 'Equities', 'XLF': 'Equities', 'XLI': 'Equities',
    'XLB': 'Equities', 'VTV': 'Equities', 'IWD': 'Equities', 'ARKX': 'Equities', 'BOTZ': 'Equities',
    'EEM': 'Equities', 'AA': 'Equities',
    'TLT': 'Bonds', 'LQD': 'Bonds', 'IEF': 'Bonds', 'VGLT': 'Bonds', 'MUB': 'Bonds', 'TIP': 'Bonds', 'VTIP': 'Bonds',
    'GLD': 'Commodities', 'DBC': 'Commodities', 'XLE': 'Commodities', 'XOP': 'Commodities', 'FCG': 'Commodities',
    'USO': 'Commodities', 'GCC': 'Commodities', 'DBA': 'Commodities', 'REMX': 'Commodities', 'URA': 'Commodities',
    'LIT': 'Commodities', 'PALL': 'Commodities', 'VALT': 'Commodities', 'SLV': 'Commodities',
    'BTC-USD': 'Crypto',
    'VNQ': 'Real Assets', 'PAVE': 'Real Assets'
} %}

<div class="space-y-6">
    <!-- Header -->
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Portfolio Allocation</h1>
        <p class="text-gray-500 dark:text-gray-400 mt-1">
            Detailed position sizing and allocation breakdown
        </p>
    </div>

    <!-- Summary Stats -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5">
            <div class="text-sm text-gray-500 dark:text-gray-400">Total Leverage</div>
            <div class="text-2xl font-bold text-navy dark:text-white">{{ "%.2f"|format(signals.total_leverage) }}x</div>
            <div class="text-xs text-gray-400">Target exposure</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5">
            <div class="text-sm text-gray-500 dark:text-gray-400">Positions</div>
            <div class="text-2xl font-bold text-navy dark:text-white">{{ positions|length }}</div>
            <div class="text-xs text-gray-400">Active holdings</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5">
            <div class="text-sm text-gray-500 dark:text-gray-400">Largest Position</div>
            <div class="text-2xl font-bold text-navy dark:text-white">
                {% if positions %}{{ (positions[0].weight * 100)|round(1) }}%{% else %}0%{% endif %}
            </div>
            <div class="text-xs text-gray-400">{{ positions[0].ticker if positions else 'N/A' }}</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5">
            <div class="text-sm text-gray-500 dark:text-gray-400">Regime</div>
            <div class="text-2xl font-bold text-gold">{{ signals.current_regime }}</div>
            <div class="text-xs text-gray-400">Current quadrants</div>
        </div>
    </div>

    <!-- Asset Class Exposure -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
        <div class="mb-4">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Asset Class Exposure</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400">Target exposure by category ({{ "%.1f"|format(signals.total_leverage) }}x total leverage)</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Donut Chart -->
            <div class="h-64">
                <canvas id="allocationChart"></canvas>
            </div>

            <!-- Breakdown List -->
            <div class="space-y-4">
                {% set colors = {'Equities': '#0F4C75', 'Bonds': '#60A5FA', 'Commodities': '#D4A857', 'Crypto': '#8B5CF6', 'Real Assets': '#10B981', 'Cash': '#9CA3AF'} %}
                {% for asset_class, weight in breakdown.items() %}
                    {% if weight > 0 %}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-4 h-4 rounded" style="background-color: {{ colors[asset_class] }}"></div>
                            <span class="font-medium text-gray-900 dark:text-white">{{ asset_class }}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-gray-900 dark:text-white">{{ (weight * 100)|round(1) }}%</div>
                            <div class="text-xs text-gray-500">${{ "{:,.0f}".format(weight * 10000) }} / $10k</div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Historical Asset Class Exposure (Daily, Last 2 Years) -->
    {% if asset_class_daily and asset_class_daily|length > 0 %}
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Historical Asset Class Exposure</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400">Daily exposure over last 2 years â€” stacked to show total leverage</p>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-500">Current Total</div>
                <div class="text-xl font-bold text-navy">{{ "%.0f"|format(signals.total_leverage * 100) }}%</div>
            </div>
        </div>
        <div class="h-80">
            <canvas id="historyChart"></canvas>
        </div>
        <!-- Current Exposure vs Historical Percentiles -->
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            <div class="text-xs font-medium text-gray-500 mb-3">Current Holdings vs Historical (2yr percentile)</div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="percentileGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Position Details -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Position Details</h2>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr class="text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        <th class="px-4 py-3">#</th>
                        <th class="px-4 py-3">Asset</th>
                        <th class="px-4 py-3">Category</th>
                        <th class="px-4 py-3">Weight</th>
                        <th class="px-4 py-3">Notional ($10k)</th>
                        <th class="px-4 py-3">Quadrant</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {% for pos in positions %}
                    {% set category = asset_categories.get(pos.ticker, 'Other') %}
                    <tr class="data-row">
                        <td class="px-4 py-3 text-gray-500 dark:text-gray-400">{{ loop.index }}</td>
                        <td class="px-4 py-3">
                            <div>
                                <span class="font-semibold text-gray-900 dark:text-white">{{ asset_names.get(pos.ticker, pos.ticker) }}</span>
                                <span class="text-xs text-gray-400 ml-1">{{ pos.ticker }}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                {% if category == 'Equities' %}bg-navy/10 text-navy
                                {% elif category == 'Bonds' %}bg-blue-100 text-blue-700
                                {% elif category == 'Commodities' %}bg-gold/10 text-gold-dark
                                {% elif category == 'Crypto' %}bg-purple-100 text-purple-700
                                {% elif category == 'Real Assets' %}bg-green-100 text-green-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                {{ category }}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-24 bg-gray-200 dark:bg-gray-600 rounded-full h-2.5">
                                    <div class="bg-navy dark:bg-gold h-2.5 rounded-full" style="width: {{ (pos.weight / signals.total_leverage * 100)|round }}%"></div>
                                </div>
                                <span class="font-medium text-gray-900 dark:text-white">{{ (pos.weight * 100)|round(2) }}%</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">
                            ${{ "{:,.0f}".format(pos.notional_10k) }}
                        </td>
                        <td class="px-4 py-3">
                            {% for quad in pos.quadrants %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium mr-1
                                {% if quad == 'Q1' %}bg-success/10 text-success
                                {% elif quad == 'Q2' %}bg-gold/10 text-gold-dark
                                {% elif quad == 'Q3' %}bg-warning/10 text-warning
                                {% else %}bg-navy/10 text-navy{% endif %}">
                                {{ quad }}
                            </span>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="bg-gray-50 dark:bg-gray-700">
                    <tr class="font-semibold">
                        <td class="px-4 py-3" colspan="3">Total</td>
                        <td class="px-4 py-3">{{ (signals.total_leverage * 100)|round(1) }}%</td>
                        <td class="px-4 py-3">${{ "{:,.0f}".format(signals.total_leverage * 10000) }}</td>
                        <td class="px-4 py-3"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Quadrant Allocation Info -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for quad in signals.top_quadrants %}
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 ring-2 ring-gold/30">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                {{ quad }} - {{ quad_descriptions[quad].split('(')[1].replace(')', '') }}
            </h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                {{ quad_descriptions[quad] }}
            </p>

            <div class="text-sm text-gray-600 dark:text-gray-300">
                <div class="font-medium mb-2">Assets in this quadrant:</div>
                <div class="flex flex-wrap gap-2">
                    {% for ticker in quad_allocations[quad].keys() %}
                    <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">{{ ticker }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Allocation Donut Chart
    const ctx = document.getElementById('allocationChart').getContext('2d');

    const breakdown = {{ breakdown | tojson }};
    const labels = Object.keys(breakdown).filter(k => breakdown[k] > 0);
    const data = labels.map(k => (breakdown[k] * 100).toFixed(1));

    const colors = {
        'Equities': '#0F4C75',
        'Bonds': '#60A5FA',
        'Commodities': '#D4A857',
        'Crypto': '#8B5CF6',
        'Real Assets': '#10B981',
        'Cash': '#9CA3AF'
    };

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: labels.map(l => colors[l]),
                borderWidth: 0,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Historical Asset Class Exposure Chart (Daily, Last 2 Years) - Stacked Bar
    const dailyData = {{ asset_class_daily | tojson }};
    const currentExposure = {{ current_exposure | tojson }};

    if (dailyData && dailyData.length > 0) {
        const historyCtx = document.getElementById('historyChart').getContext('2d');
        const historyLabels = dailyData.map(d => d.date);

        const assetClasses = ['Equities', 'Commodities', 'Crypto', 'Bonds', 'Real Assets'];

        // Create stacked bar datasets
        const datasets = assetClasses.map(ac => ({
            label: ac,
            data: dailyData.map(d => d[ac] || 0),
            backgroundColor: colors[ac],
            borderColor: colors[ac],
            borderWidth: 0,
        }));

        new Chart(historyCtx, {
            type: 'bar',
            data: {
                labels: historyLabels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        stacked: true,
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxTicksLimit: 12,
                            maxRotation: 0,
                            callback: function(value, index) {
                                const date = historyLabels[index];
                                if (date) {
                                    const d = new Date(date);
                                    return d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                                }
                                return '';
                            }
                        }
                    },
                    y: {
                        stacked: true,
                        min: 0,
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 8,
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const date = tooltipItems[0].label;
                                return new Date(date).toLocaleDateString('en-US', {
                                    month: 'short', day: 'numeric', year: 'numeric'
                                });
                            },
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                            },
                            afterBody: function(tooltipItems) {
                                const total = tooltipItems.reduce((sum, item) => sum + item.parsed.y, 0);
                                return `\nTotal Exposure: ${total.toFixed(0)}%`;
                            }
                        }
                    }
                }
            }
        });

        // Calculate percentiles for each asset class
        function calculatePercentile(values, current) {
            if (values.length === 0) return 0;
            const sorted = [...values].sort((a, b) => a - b);
            const count = sorted.filter(v => v <= current).length;
            return Math.round((count / sorted.length) * 100);
        }

        const percentileGrid = document.getElementById('percentileGrid');
        if (percentileGrid) {
            // Only show cards for asset classes with actual current holdings
            const heldAssetClasses = assetClasses.filter(ac => (currentExposure[ac] || 0) > 0);

            heldAssetClasses.forEach(ac => {
                const historicalValues = dailyData.map(d => d[ac] || 0);
                const current = currentExposure[ac] || 0;
                const percentile = calculatePercentile(historicalValues, current);

                // Determine color based on percentile
                let percentileColor = 'text-gray-600';
                let bgColor = 'bg-gray-100';
                if (percentile >= 80) {
                    percentileColor = 'text-success';
                    bgColor = 'bg-success/10';
                } else if (percentile >= 60) {
                    percentileColor = 'text-gold-dark';
                    bgColor = 'bg-gold/10';
                } else if (percentile <= 20) {
                    percentileColor = 'text-warning';
                    bgColor = 'bg-warning/10';
                } else if (percentile <= 40) {
                    percentileColor = 'text-navy';
                    bgColor = 'bg-navy/10';
                }

                const card = document.createElement('div');
                card.className = `${bgColor} rounded-lg p-3 text-center`;
                card.innerHTML = `
                    <div class="flex items-center justify-center gap-2 mb-1">
                        <div class="w-3 h-3 rounded-full" style="background-color: ${colors[ac]}"></div>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300">${ac}</span>
                    </div>
                    <div class="text-2xl font-bold ${percentileColor}">${percentile}<span class="text-sm">th</span></div>
                    <div class="text-xs text-gray-500">${current}% exposure</div>
                `;
                percentileGrid.appendChild(card);
            });
        }
    }
</script>
{% endblock %}

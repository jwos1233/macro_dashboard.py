{% extends "base.html" %}

{% block title %}Dashboard - Epoch Macro{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header Row: Regime + Quick Stats -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Regime Indicator (Signature Visual) -->
        <div class="lg:col-span-1 bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
            <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-4">Current Regime</h2>

            <!-- 4-Quadrant Grid -->
            <div class="grid grid-cols-2 gap-2 mb-4">
                <!-- Q1: Goldilocks (top-right) -->
                <div class="order-2 regime-quadrant rounded-lg p-4 text-center transition-all
                            {% if 'Q1' in signals.top_quadrants %}active bg-success/20 border-2 border-success{% else %}bg-gray-100 dark:bg-gray-700{% endif %}">
                    <div class="text-xs font-medium text-gray-500 dark:text-gray-400">Q1</div>
                    <div class="text-sm font-semibold {% if 'Q1' in signals.top_quadrants %}text-success{% else %}text-gray-600 dark:text-gray-300{% endif %}">
                        Goldilocks
                    </div>
                    <div class="text-lg font-bold {% if 'Q1' in signals.top_quadrants %}text-success{% else %}text-gray-400{% endif %}">
                        {{ "%.1f"|format(signals.quadrant_scores['Q1']) }}%
                    </div>
                </div>

                <!-- Q2: Reflation (top-left) -->
                <div class="order-1 regime-quadrant rounded-lg p-4 text-center transition-all
                            {% if 'Q2' in signals.top_quadrants %}active bg-gold/20 border-2 border-gold{% else %}bg-gray-100 dark:bg-gray-700{% endif %}">
                    <div class="text-xs font-medium text-gray-500 dark:text-gray-400">Q2</div>
                    <div class="text-sm font-semibold {% if 'Q2' in signals.top_quadrants %}text-gold{% else %}text-gray-600 dark:text-gray-300{% endif %}">
                        Reflation
                    </div>
                    <div class="text-lg font-bold {% if 'Q2' in signals.top_quadrants %}text-gold{% else %}text-gray-400{% endif %}">
                        {{ "%.1f"|format(signals.quadrant_scores['Q2']) }}%
                    </div>
                </div>

                <!-- Q3: Stagflation (bottom-left) -->
                <div class="order-3 regime-quadrant rounded-lg p-4 text-center transition-all
                            {% if 'Q3' in signals.top_quadrants %}active bg-warning/20 border-2 border-warning{% else %}bg-gray-100 dark:bg-gray-700{% endif %}">
                    <div class="text-xs font-medium text-gray-500 dark:text-gray-400">Q3</div>
                    <div class="text-sm font-semibold {% if 'Q3' in signals.top_quadrants %}text-warning{% else %}text-gray-600 dark:text-gray-300{% endif %}">
                        Stagflation
                    </div>
                    <div class="text-lg font-bold {% if 'Q3' in signals.top_quadrants %}text-warning{% else %}text-gray-400{% endif %}">
                        {{ "%.1f"|format(signals.quadrant_scores['Q3']) }}%
                    </div>
                </div>

                <!-- Q4: Deflation (bottom-right) -->
                <div class="order-4 regime-quadrant rounded-lg p-4 text-center transition-all
                            {% if 'Q4' in signals.top_quadrants %}active bg-navy/20 border-2 border-navy{% else %}bg-gray-100 dark:bg-gray-700{% endif %}">
                    <div class="text-xs font-medium text-gray-500 dark:text-gray-400">Q4</div>
                    <div class="text-sm font-semibold {% if 'Q4' in signals.top_quadrants %}text-navy{% else %}text-gray-600 dark:text-gray-300{% endif %}">
                        Deflation
                    </div>
                    <div class="text-lg font-bold {% if 'Q4' in signals.top_quadrants %}text-navy{% else %}text-gray-400{% endif %}">
                        {{ "%.1f"|format(signals.quadrant_scores['Q4']) }}%
                    </div>
                </div>
            </div>

            <!-- Active Regime Badge -->
            <div class="text-center">
                <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-navy text-white">
                    Active: {{ signals.current_regime }}
                </span>
            </div>
        </div>

        <!-- Quick Stats Cards -->
        <div class="lg:col-span-2 grid grid-cols-2 sm:grid-cols-4 gap-4">
            <!-- YTD Return -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5">
                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">YTD Return</div>
                <div class="text-2xl font-bold {% if performance.ytd_return >= 0 %}text-success{% else %}text-warning{% endif %} mt-1">
                    {% if performance.ytd_return >= 0 %}+{% endif %}{{ "%.1f"|format(performance.ytd_return) }}%
                </div>
                <div class="text-xs text-gray-400 mt-1">2025 performance</div>
            </div>

            <!-- Total Return -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5">
                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Return</div>
                <div class="text-2xl font-bold {% if performance.total_return >= 0 %}text-success{% else %}text-warning{% endif %} mt-1">
                    {% if performance.total_return >= 0 %}+{% endif %}{{ "%.1f"|format(performance.total_return) }}%
                </div>
                <div class="text-xs text-gray-400 mt-1">Since inception</div>
            </div>

            <!-- Sharpe Ratio -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5">
                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Sharpe Ratio</div>
                <div class="text-2xl font-bold text-navy dark:text-white mt-1">
                    {{ "%.2f"|format(performance.sharpe) }}
                </div>
                <div class="text-xs text-gray-400 mt-1">Risk-adjusted</div>
            </div>

            <!-- Max Drawdown -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5">
                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Max Drawdown</div>
                <div class="text-2xl font-bold text-warning mt-1">
                    {{ "%.1f"|format(performance.max_drawdown) }}%
                </div>
                <div class="text-xs text-gray-400 mt-1">Worst decline</div>
            </div>
        </div>
    </div>

    <!-- Asset Class Allocation Bar -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Asset Allocation</h2>
            <a href="/dashboard/allocation" class="text-sm text-navy dark:text-gold hover:underline">View Details &rarr;</a>
        </div>

        <!-- Allocation Bar -->
        <div class="h-8 rounded-lg overflow-hidden flex mb-4">
            {% set colors = {'Equities': 'bg-navy', 'Bonds': 'bg-blue-400', 'Commodities': 'bg-gold', 'Crypto': 'bg-purple-500', 'Real Assets': 'bg-green-500', 'Cash': 'bg-gray-300'} %}
            {% for asset_class, weight in breakdown.items() %}
                {% if weight > 0 %}
                <div class="allocation-segment {{ colors[asset_class] }}"
                     style="width: {{ (weight * 100)|round(1) }}%"
                     title="{{ asset_class }}: {{ (weight * 100)|round(1) }}%">
                </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- Legend -->
        <div class="flex flex-wrap gap-4 text-sm">
            {% for asset_class, weight in breakdown.items() %}
                {% if weight > 0 %}
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded {{ colors[asset_class] }}"></div>
                    <span class="text-gray-600 dark:text-gray-300">{{ asset_class }}</span>
                    <span class="font-medium text-gray-900 dark:text-white">{{ (weight * 100)|round(1) }}%</span>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Top Positions Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Top Positions</h2>
            <a href="/dashboard/signals" class="text-sm text-navy dark:text-gold hover:underline">View All Signals &rarr;</a>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        <th class="pb-3">Ticker</th>
                        <th class="pb-3">Weight</th>
                        <th class="pb-3">Notional ($10k)</th>
                        <th class="pb-3 hidden sm:table-cell">Signal</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {% for ticker, weight in top_positions %}
                    <tr class="data-row">
                        <td class="py-3">
                            <span class="font-medium text-gray-900 dark:text-white">{{ ticker }}</span>
                        </td>
                        <td class="py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-16 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div class="bg-navy h-2 rounded-full" style="width: {{ (weight / signals.total_leverage * 100)|round }}%"></div>
                                </div>
                                <span class="text-sm text-gray-600 dark:text-gray-300">{{ (weight * 100)|round(1) }}%</span>
                            </div>
                        </td>
                        <td class="py-3 text-gray-600 dark:text-gray-300">
                            ${{ "{:,.0f}".format(weight * 10000) }}
                        </td>
                        <td class="py-3 hidden sm:table-cell">
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-success/10 text-success">
                                Long
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Quadrant Scores Chart -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Quadrant Momentum Scores</h2>
        <div class="h-64">
            <canvas id="quadrantChart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Quadrant Scores Bar Chart
    const ctx = document.getElementById('quadrantChart').getContext('2d');

    const scores = {
        'Q1': {{ signals.quadrant_scores['Q1'] }},
        'Q2': {{ signals.quadrant_scores['Q2'] }},
        'Q3': {{ signals.quadrant_scores['Q3'] }},
        'Q4': {{ signals.quadrant_scores['Q4'] }}
    };

    const topQuads = ['{{ signals.top_quadrants[0] }}', '{{ signals.top_quadrants[1] }}'];

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Q1 Goldilocks', 'Q2 Reflation', 'Q3 Stagflation', 'Q4 Deflation'],
            datasets: [{
                label: 'Momentum Score (%)',
                data: [scores.Q1, scores.Q2, scores.Q3, scores.Q4],
                backgroundColor: [
                    topQuads.includes('Q1') ? '#059669' : '#9CA3AF',
                    topQuads.includes('Q2') ? '#D4A857' : '#9CA3AF',
                    topQuads.includes('Q3') ? '#B91C1C' : '#9CA3AF',
                    topQuads.includes('Q4') ? '#0F4C75' : '#9CA3AF',
                ],
                borderRadius: 8,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
</script>
{% endblock %}

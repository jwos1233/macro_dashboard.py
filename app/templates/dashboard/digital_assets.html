{% extends "base.html" %}

{% block title %}Digital Assets - Epoch Macro{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center flex-wrap gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Digital Asset Framework</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">BTC allocation based on quad regime with EMA trend filter</p>
        </div>
        <div class="flex items-center gap-4">
            <!-- Time Range Filter Buttons -->
            <div class="flex rounded-lg overflow-hidden border border-gray-300 dark:border-gray-600" id="timeRangeFilter">
                <button data-range="all" class="px-3 py-1.5 text-sm font-medium bg-navy text-white">All</button>
                <button data-range="2y" class="px-3 py-1.5 text-sm font-medium bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 border-l border-gray-300 dark:border-gray-600">2Y</button>
                <button data-range="1y" class="px-3 py-1.5 text-sm font-medium bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 border-l border-gray-300 dark:border-gray-600">1Y</button>
                <button data-range="6m" class="px-3 py-1.5 text-sm font-medium bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 border-l border-gray-300 dark:border-gray-600">6M</button>
                <button data-range="ytd" class="px-3 py-1.5 text-sm font-medium bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 border-l border-gray-300 dark:border-gray-600">YTD</button>
            </div>
            <div class="text-sm text-gray-500 dark:text-gray-400">
                {% if btc_data.generated_at %}
                Generated: {{ btc_data.generated_at }}
                {% endif %}
            </div>
        </div>
    </div>

    {% if btc_data.error %}
    <!-- Error State -->
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
        <p class="text-red-800 dark:text-red-200">Error running backtest: {{ btc_data.error }}</p>
    </div>
    {% else %}

    <!-- Current Signal Card -->
    <div class="bg-navy dark:bg-gray-800 rounded-lg shadow p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold mb-1">Current Position</h3>
                <p class="text-4xl font-bold
                    {% if btc_data.current_position == 'Overweight' %}text-green-400
                    {% elif btc_data.current_position == 'Neutral' %}text-yellow-400
                    {% else %}text-red-400{% endif %}">
                    {{ btc_data.current_position }}
                </p>
                <p class="text-sm text-gray-300 mt-1">
                    {% if btc_data.current_position == 'Overweight' %}200% Allocation
                    {% elif btc_data.current_position == 'Short' %}-25% Allocation
                    {% else %}0% Allocation{% endif %}
                </p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-300">BTC Price</p>
                {% set last_price = btc_data.chart_data[-1].btc_price if btc_data.chart_data else 0 %}
                {% set last_ema = btc_data.chart_data[-1].ema if btc_data.chart_data else 0 %}
                <p class="text-3xl font-bold">${{ "{:,.0f}".format(last_price) }}</p>
                <p class="text-sm text-gray-300 mt-2">EMA (50d): ${{ "{:,.0f}".format(last_ema) }}</p>
            </div>
        </div>
    </div>

    <!-- Strategy Performance Summary -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Strategy Performance Summary</h3>
            <span id="summary-time-period" class="text-sm text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">All Time</span>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            <!-- BTC-Only Strategy -->
            <div class="text-center border-r border-gray-200 dark:border-gray-700 last:border-r-0">
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">BTC-Only</p>
                <p id="summary-btc-pnl" class="text-2xl font-bold {% if btc_data.strategy.total_return >= 0 %}text-success{% else %}text-warning{% endif %}">
                    {{ "%.1f"|format(btc_data.strategy.total_return or 0) }}%
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Sharpe: <span id="summary-btc-sharpe" class="font-medium text-gray-700 dark:text-gray-300">{{ "%.2f"|format(btc_data.strategy.sharpe or 0) }}</span>
                </p>
            </div>
            <!-- Inverse Vol Strategy -->
            <div class="text-center border-r border-gray-200 dark:border-gray-700 last:border-r-0">
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Inverse Vol</p>
                <p id="summary-invvol-pnl" class="text-2xl font-bold {% if vol_data and vol_data.strategy.total_return >= 0 %}text-success{% else %}text-warning{% endif %}">
                    {{ "%.1f"|format(vol_data.strategy.total_return or 0) if vol_data else "N/A" }}%
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Sharpe: <span id="summary-invvol-sharpe" class="font-medium text-gray-700 dark:text-gray-300">{{ "%.2f"|format(vol_data.strategy.sharpe or 0) if vol_data else "N/A" }}</span>
                </p>
            </div>
            <!-- Vol Chase Strategy -->
            <div class="text-center border-r border-gray-200 dark:border-gray-700 last:border-r-0">
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Vol Chase</p>
                <p id="summary-volchase-pnl" class="text-2xl font-bold {% if vol_chase_data and vol_chase_data.strategy.total_return >= 0 %}text-success{% else %}text-warning{% endif %}">
                    {{ "%.1f"|format(vol_chase_data.strategy.total_return or 0) if vol_chase_data else "N/A" }}%
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Sharpe: <span id="summary-volchase-sharpe" class="font-medium text-gray-700 dark:text-gray-300">{{ "%.2f"|format(vol_chase_data.strategy.sharpe or 0) if vol_chase_data else "N/A" }}</span>
                </p>
            </div>
            <!-- Buy & Hold -->
            <div class="text-center">
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Buy & Hold</p>
                <p id="summary-bh-pnl" class="text-2xl font-bold {% if btc_data.buyhold.total_return >= 0 %}text-success{% else %}text-warning{% endif %}">
                    {{ "%.1f"|format(btc_data.buyhold.total_return or 0) }}%
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Sharpe: <span id="summary-bh-sharpe" class="font-medium text-gray-700 dark:text-gray-300">{{ "%.2f"|format(btc_data.buyhold.sharpe or 0) }}</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Performance Comparison Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Strategy Return</p>
            <p id="stat-strategy-return" class="text-2xl font-bold {% if btc_data.strategy.total_return >= 0 %}text-success{% else %}text-warning{% endif %}">
                {{ "%.1f"|format(btc_data.strategy.total_return or 0) }}%
            </p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Buy & Hold Return</p>
            <p id="stat-buyhold-return" class="text-2xl font-bold {% if btc_data.buyhold.total_return >= 0 %}text-success{% else %}text-warning{% endif %}">
                {{ "%.1f"|format(btc_data.buyhold.total_return or 0) }}%
            </p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Strategy Sharpe</p>
            <p id="stat-strategy-sharpe" class="text-2xl font-bold text-gray-900 dark:text-white">{{ "%.2f"|format(btc_data.strategy.sharpe or 0) }}</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Buy & Hold Sharpe</p>
            <p id="stat-buyhold-sharpe" class="text-2xl font-bold text-gray-900 dark:text-white">{{ "%.2f"|format(btc_data.buyhold.sharpe or 0) }}</p>
        </div>
    </div>

    <!-- Additional Stats -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Strategy Max DD</p>
            <p id="stat-strategy-maxdd" class="text-xl font-bold text-warning">{{ "%.1f"|format(btc_data.strategy.max_drawdown or 0) }}%</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Buy & Hold Max DD</p>
            <p id="stat-buyhold-maxdd" class="text-xl font-bold text-warning">{{ "%.1f"|format(btc_data.buyhold.max_drawdown or 0) }}%</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Strategy Volatility</p>
            <p id="stat-strategy-vol" class="text-xl font-bold text-gray-900 dark:text-white">{{ "%.1f"|format(btc_data.strategy.volatility or 0) }}%</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Position Changes</p>
            <p id="stat-position-changes" class="text-xl font-bold text-gray-900 dark:text-white">{{ btc_data.regime_history|length }}</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400" id="stat-final-value-label">Final Value (${{ "{:,.0f}".format(btc_data.parameters.initial_capital or 10000) }} start)</p>
            <p id="stat-final-value" class="text-xl font-bold text-gray-900 dark:text-white">${{ "{:,.0f}".format(btc_data.strategy.final_value or 10000) }}</p>
        </div>
    </div>

    <!-- BTC Chart with Position Overlay -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">BTC Price with Position Overlay</h3>
        <div class="h-96">
            <canvas id="btcChart"></canvas>
        </div>
    </div>

    <!-- Equity Curves Comparison - All Strategies -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Equity Curve: All Strategies</h3>
        <div class="h-80">
            <canvas id="equityChart"></canvas>
        </div>
    </div>

    <!-- Position Distribution -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Position Distribution</h3>
        <div id="position-distribution" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center">
                <div class="w-full h-4 bg-gray-200 dark:bg-gray-700 rounded overflow-hidden mb-2">
                    <div id="pos-bar-overweight" class="h-full bg-green-500" style="width: {{ btc_data.position_breakdown.get('Overweight', 0) }}%"></div>
                </div>
                <p class="text-sm font-medium text-gray-900 dark:text-white">Overweight</p>
                <p id="pos-pct-overweight" class="text-2xl font-bold text-gray-700 dark:text-gray-300">{{ "%.1f"|format(btc_data.position_breakdown.get('Overweight', 0)) }}%</p>
            </div>
            <div class="text-center">
                <div class="w-full h-4 bg-gray-200 dark:bg-gray-700 rounded overflow-hidden mb-2">
                    <div id="pos-bar-neutral" class="h-full bg-yellow-500" style="width: {{ btc_data.position_breakdown.get('Neutral', 0) }}%"></div>
                </div>
                <p class="text-sm font-medium text-gray-900 dark:text-white">Neutral</p>
                <p id="pos-pct-neutral" class="text-2xl font-bold text-gray-700 dark:text-gray-300">{{ "%.1f"|format(btc_data.position_breakdown.get('Neutral', 0)) }}%</p>
            </div>
            <div class="text-center">
                <div class="w-full h-4 bg-gray-200 dark:bg-gray-700 rounded overflow-hidden mb-2">
                    <div id="pos-bar-underweight" class="h-full bg-purple-500" style="width: {{ btc_data.position_breakdown.get('Underweight', 0) }}%"></div>
                </div>
                <p class="text-sm font-medium text-gray-900 dark:text-white">Underweight</p>
                <p id="pos-pct-underweight" class="text-2xl font-bold text-gray-700 dark:text-gray-300">{{ "%.1f"|format(btc_data.position_breakdown.get('Underweight', 0)) }}%</p>
            </div>
            <div class="text-center">
                <div class="w-full h-4 bg-gray-200 dark:bg-gray-700 rounded overflow-hidden mb-2">
                    <div id="pos-bar-short" class="h-full bg-red-500" style="width: {{ btc_data.position_breakdown.get('Short', 0) }}%"></div>
                </div>
                <p class="text-sm font-medium text-gray-900 dark:text-white">Short</p>
                <p id="pos-pct-short" class="text-2xl font-bold text-gray-700 dark:text-gray-300">{{ "%.1f"|format(btc_data.position_breakdown.get('Short', 0)) }}%</p>
            </div>
        </div>
    </div>

    {% endif %}

    <!-- Multi-Asset Volatility Weighted Section -->
    {% if vol_data and not vol_data.error %}
    <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">Multi-Asset Inverse Volatility</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400">Top 10 crypto allocation weighted by inverse {{ vol_data.parameters.vol_lookback or 30 }}-day volatility</p>
            </div>
        </div>

        <!-- Current Weights Card -->
        <div class="bg-gradient-to-r from-orange-500 to-amber-500 rounded-lg shadow p-6 text-white mb-6">
            <h3 class="text-lg font-semibold mb-4">Current Inverse Vol Weights (Top 10 by MCap)</h3>
            <div class="grid grid-cols-5 md:grid-cols-10 gap-2">
                {% for asset in ['BTC', 'ETH', 'XRP', 'BNB', 'SOL', 'TRX', 'DOGE', 'ADA', 'BCH', 'LINK'] %}
                <div class="text-center">
                    <p class="text-lg md:text-xl font-bold">{{ "%.0f"|format(vol_data.current_weights[asset] or 10) }}%</p>
                    <p class="text-xs opacity-80">{{ asset }}</p>
                </div>
                {% endfor %}
            </div>
            <p class="text-xs text-center mt-4 opacity-70">Lower volatility = Higher weight (risk parity style)</p>
        </div>

        <!-- Multi-Asset Performance Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Multi-Asset Return</p>
                <p id="stat-invvol-return" class="text-2xl font-bold {% if vol_data.strategy.total_return >= 0 %}text-success{% else %}text-warning{% endif %}">
                    {{ "%.1f"|format(vol_data.strategy.total_return or 0) }}%
                </p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">BTC-Only Return</p>
                <p id="stat-invvol-btconly" class="text-2xl font-bold {% if btc_data.strategy.total_return >= 0 %}text-success{% else %}text-warning{% endif %}">
                    {{ "%.1f"|format(btc_data.strategy.total_return or 0) }}%
                </p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Multi-Asset Sharpe</p>
                <p id="stat-invvol-sharpe" class="text-2xl font-bold text-gray-900 dark:text-white">{{ "%.2f"|format(vol_data.strategy.sharpe or 0) }}</p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Multi-Asset Max DD</p>
                <p id="stat-invvol-maxdd" class="text-xl font-bold text-warning">{{ "%.1f"|format(vol_data.strategy.max_drawdown or 0) }}%</p>
            </div>
        </div>

        <!-- Asset Weight History Chart -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Asset Weight History (Inverse Vol)</h3>
            <div class="h-64">
                <canvas id="weightChart"></canvas>
            </div>
        </div>

        <!-- Volatility History Chart -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Rolling {{ vol_data.parameters.vol_lookback or 30 }}-Day Volatility</h3>
            <div class="h-64">
                <canvas id="volChart"></canvas>
            </div>
        </div>
    </div>
    {% elif vol_data and vol_data.error %}
    <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
            <p class="text-red-800 dark:text-red-200">Error running multi-asset backtest: {{ vol_data.error }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Volatility Chase (High Vol = High Weight) Section -->
    {% if vol_chase_data and not vol_chase_data.error %}
    <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">Volatility Chase (High Vol Weighting)</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400">Top 10 crypto allocation weighted by {{ vol_chase_data.parameters.vol_lookback or 30 }}-day volatility (higher vol = higher weight)</p>
            </div>
        </div>

        <!-- Current Weights Card -->
        <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg shadow p-6 text-white mb-6">
            <h3 class="text-lg font-semibold mb-4">Current Vol Chase Weights (Top 10 by MCap)</h3>
            <div class="grid grid-cols-5 md:grid-cols-10 gap-2">
                {% for asset in ['BTC', 'ETH', 'XRP', 'BNB', 'SOL', 'TRX', 'DOGE', 'ADA', 'BCH', 'LINK'] %}
                <div class="text-center">
                    <p class="text-lg md:text-xl font-bold">{{ "%.0f"|format(vol_chase_data.current_weights[asset] or 10) }}%</p>
                    <p class="text-xs opacity-80">{{ asset }}</p>
                </div>
                {% endfor %}
            </div>
            <p class="text-xs text-center mt-4 opacity-70">Higher volatility = Higher weight (momentum/trend following style)</p>
        </div>

        <!-- Vol Chase Performance Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Vol Chase Return</p>
                <p id="stat-volchase-return" class="text-2xl font-bold {% if vol_chase_data.strategy.total_return >= 0 %}text-success{% else %}text-warning{% endif %}">
                    {{ "%.1f"|format(vol_chase_data.strategy.total_return or 0) }}%
                </p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Inverse Vol Return</p>
                <p id="stat-volchase-invvol" class="text-2xl font-bold {% if vol_data.strategy.total_return >= 0 %}text-success{% else %}text-warning{% endif %}">
                    {{ "%.1f"|format(vol_data.strategy.total_return or 0) }}%
                </p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Vol Chase Sharpe</p>
                <p id="stat-volchase-sharpe" class="text-2xl font-bold text-gray-900 dark:text-white">{{ "%.2f"|format(vol_chase_data.strategy.sharpe or 0) }}</p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Vol Chase Max DD</p>
                <p id="stat-volchase-maxdd" class="text-xl font-bold text-warning">{{ "%.1f"|format(vol_chase_data.strategy.max_drawdown or 0) }}%</p>
            </div>
        </div>

        <!-- Vol Chase Weight History Chart -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Vol Chase Weight History</h3>
            <div class="h-64">
                <canvas id="volChaseWeightChart"></canvas>
            </div>
        </div>
    </div>
    {% elif vol_chase_data and vol_chase_data.error %}
    <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
            <p class="text-red-800 dark:text-red-200">Error running vol chase backtest: {{ vol_chase_data.error }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Strategy Comparison Table -->
    {% if vol_data and not vol_data.error and vol_chase_data and not vol_chase_data.error %}
    <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Performance Summary</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-200 dark:border-gray-700">
                            <th class="text-left py-2 text-gray-600 dark:text-gray-400">Strategy</th>
                            <th class="text-right py-2 text-gray-600 dark:text-gray-400">Return</th>
                            <th class="text-right py-2 text-gray-600 dark:text-gray-400">Sharpe</th>
                            <th class="text-right py-2 text-gray-600 dark:text-gray-400">Max DD</th>
                            <th class="text-right py-2 text-gray-600 dark:text-gray-400">Volatility</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b border-gray-100 dark:border-gray-700">
                            <td class="py-2 font-medium text-gray-900 dark:text-white">BTC-Only</td>
                            <td id="tbl-btc-return" class="text-right py-2 {% if btc_data.strategy.total_return >= 0 %}text-success{% else %}text-warning{% endif %}">{{ "%.1f"|format(btc_data.strategy.total_return or 0) }}%</td>
                            <td id="tbl-btc-sharpe" class="text-right py-2 text-gray-700 dark:text-gray-300">{{ "%.2f"|format(btc_data.strategy.sharpe or 0) }}</td>
                            <td id="tbl-btc-maxdd" class="text-right py-2 text-warning">{{ "%.1f"|format(btc_data.strategy.max_drawdown or 0) }}%</td>
                            <td id="tbl-btc-vol" class="text-right py-2 text-gray-700 dark:text-gray-300">{{ "%.1f"|format(btc_data.strategy.volatility or 0) }}%</td>
                        </tr>
                        <tr class="border-b border-gray-100 dark:border-gray-700">
                            <td class="py-2 font-medium text-gray-900 dark:text-white">Inverse Vol (Low Vol = High Weight)</td>
                            <td id="tbl-invvol-return" class="text-right py-2 {% if vol_data.strategy.total_return >= 0 %}text-success{% else %}text-warning{% endif %}">{{ "%.1f"|format(vol_data.strategy.total_return or 0) }}%</td>
                            <td id="tbl-invvol-sharpe" class="text-right py-2 text-gray-700 dark:text-gray-300">{{ "%.2f"|format(vol_data.strategy.sharpe or 0) }}</td>
                            <td id="tbl-invvol-maxdd" class="text-right py-2 text-warning">{{ "%.1f"|format(vol_data.strategy.max_drawdown or 0) }}%</td>
                            <td id="tbl-invvol-vol" class="text-right py-2 text-gray-700 dark:text-gray-300">{{ "%.1f"|format(vol_data.strategy.volatility or 0) }}%</td>
                        </tr>
                        <tr class="border-b border-gray-100 dark:border-gray-700">
                            <td class="py-2 font-medium text-gray-900 dark:text-white">Vol Chase (High Vol = High Weight)</td>
                            <td id="tbl-volchase-return" class="text-right py-2 {% if vol_chase_data.strategy.total_return >= 0 %}text-success{% else %}text-warning{% endif %}">{{ "%.1f"|format(vol_chase_data.strategy.total_return or 0) }}%</td>
                            <td id="tbl-volchase-sharpe" class="text-right py-2 text-gray-700 dark:text-gray-300">{{ "%.2f"|format(vol_chase_data.strategy.sharpe or 0) }}</td>
                            <td id="tbl-volchase-maxdd" class="text-right py-2 text-warning">{{ "%.1f"|format(vol_chase_data.strategy.max_drawdown or 0) }}%</td>
                            <td id="tbl-volchase-vol" class="text-right py-2 text-gray-700 dark:text-gray-300">{{ "%.1f"|format(vol_chase_data.strategy.volatility or 0) }}%</td>
                        </tr>
                        <tr>
                            <td class="py-2 font-medium text-gray-500 dark:text-gray-400">BTC Buy & Hold</td>
                            <td id="tbl-bh-return" class="text-right py-2 {% if btc_data.buyhold.total_return >= 0 %}text-success{% else %}text-warning{% endif %}">{{ "%.1f"|format(btc_data.buyhold.total_return or 0) }}%</td>
                            <td id="tbl-bh-sharpe" class="text-right py-2 text-gray-500 dark:text-gray-400">{{ "%.2f"|format(btc_data.buyhold.sharpe or 0) }}</td>
                            <td id="tbl-bh-maxdd" class="text-right py-2 text-warning">{{ "%.1f"|format(btc_data.buyhold.max_drawdown or 0) }}%</td>
                            <td id="tbl-bh-vol" class="text-right py-2 text-gray-500 dark:text-gray-400">{{ "%.1f"|format(btc_data.buyhold.volatility or 0) }}%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if not btc_data.error and btc_data.chart_data %}
    const fullPriceData = {{ btc_data.chart_data | tojson }};
    const initialCapital = {{ btc_data.parameters.initial_capital or 10000 }};
    let currentRange = 'all';
    let btcChart = null;
    let equityChart = null;
    let invVolEquityChart = null;
    let volChaseEquityChart = null;

    // Store full data for multi-asset charts (will be populated if available)
    let fullInvVolData = null;
    let fullVolChaseData = null;

    // Position color mapping
    const positionColors = {
        'Overweight': 'rgba(34, 197, 94, 0.3)',
        'Neutral': 'rgba(234, 179, 8, 0.3)',
        'Underweight': 'rgba(168, 85, 247, 0.3)',
        'Short': 'rgba(239, 68, 68, 0.3)'
    };

    // Filter data by date range
    function filterDataByRange(data, range) {
        if (range === 'all') return data;

        const now = new Date();
        let cutoffDate;

        switch(range) {
            case '2y':
                cutoffDate = new Date(now.getFullYear() - 2, now.getMonth(), now.getDate());
                break;
            case '1y':
                cutoffDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                break;
            case '6m':
                cutoffDate = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
                break;
            case 'ytd':
                cutoffDate = new Date(now.getFullYear(), 0, 1);
                break;
            default:
                return data;
        }

        return data.filter(d => new Date(d.date) >= cutoffDate);
    }

    // Calculate statistics for filtered data
    function calculateStats(data) {
        if (data.length < 2) return null;

        const startValue = data[0].portfolio_value;
        const endValue = data[data.length - 1].portfolio_value;
        const startBuyhold = data[0].buyhold_value;
        const endBuyhold = data[data.length - 1].buyhold_value;

        // Returns
        const strategyReturn = ((endValue / startValue) - 1) * 100;
        const buyholdReturn = ((endBuyhold / startBuyhold) - 1) * 100;

        // Daily returns for volatility/sharpe
        const strategyReturns = [];
        const buyholdReturns = [];
        for (let i = 1; i < data.length; i++) {
            strategyReturns.push((data[i].portfolio_value / data[i-1].portfolio_value) - 1);
            buyholdReturns.push((data[i].buyhold_value / data[i-1].buyhold_value) - 1);
        }

        // Volatility (annualized)
        const strategyVol = stdDev(strategyReturns) * Math.sqrt(252) * 100;
        const buyholdVol = stdDev(buyholdReturns) * Math.sqrt(252) * 100;

        // Annualized return
        const tradingDays = data.length;
        const years = tradingDays / 252;
        const strategyAnnual = (Math.pow(endValue / startValue, 1/years) - 1) * 100;
        const buyholdAnnual = (Math.pow(endBuyhold / startBuyhold, 1/years) - 1) * 100;

        // Sharpe (assuming 5% risk-free)
        const strategySharpe = strategyVol > 0 ? (strategyAnnual - 5) / strategyVol : 0;
        const buyholdSharpe = buyholdVol > 0 ? (buyholdAnnual - 5) / buyholdVol : 0;

        // Max Drawdown
        const strategyMaxDD = calcMaxDrawdown(data.map(d => d.portfolio_value));
        const buyholdMaxDD = calcMaxDrawdown(data.map(d => d.buyhold_value));

        // Position breakdown
        const positionCounts = { Overweight: 0, Neutral: 0, Underweight: 0, Short: 0 };
        data.forEach(d => {
            if (positionCounts.hasOwnProperty(d.position)) {
                positionCounts[d.position]++;
            }
        });
        const total = data.length;
        const positionPcts = {
            Overweight: (positionCounts.Overweight / total) * 100,
            Neutral: (positionCounts.Neutral / total) * 100,
            Underweight: (positionCounts.Underweight / total) * 100,
            Short: (positionCounts.Short / total) * 100
        };

        // Count position changes
        let positionChanges = 0;
        for (let i = 1; i < data.length; i++) {
            if (data[i].position !== data[i-1].position) positionChanges++;
        }

        return {
            strategyReturn,
            buyholdReturn,
            strategySharpe,
            buyholdSharpe,
            strategyMaxDD,
            buyholdMaxDD,
            strategyVol,
            buyholdVol,
            positionPcts,
            positionChanges,
            finalValue: endValue,
            startValue
        };
    }

    function stdDev(arr) {
        if (arr.length === 0) return 0;
        const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
        const variance = arr.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / arr.length;
        return Math.sqrt(variance);
    }

    function calcMaxDrawdown(values) {
        let maxDD = 0;
        let peak = values[0];
        for (let i = 1; i < values.length; i++) {
            if (values[i] > peak) peak = values[i];
            const dd = (values[i] - peak) / peak;
            if (dd < maxDD) maxDD = dd;
        }
        return maxDD * 100;
    }

    // Update statistics display
    function updateStats(stats) {
        if (!stats) return;

        // Update return colors
        const stratRetEl = document.getElementById('stat-strategy-return');
        const bhRetEl = document.getElementById('stat-buyhold-return');

        stratRetEl.textContent = stats.strategyReturn.toFixed(1) + '%';
        stratRetEl.className = 'text-2xl font-bold ' + (stats.strategyReturn >= 0 ? 'text-success' : 'text-warning');

        bhRetEl.textContent = stats.buyholdReturn.toFixed(1) + '%';
        bhRetEl.className = 'text-2xl font-bold ' + (stats.buyholdReturn >= 0 ? 'text-success' : 'text-warning');

        document.getElementById('stat-strategy-sharpe').textContent = stats.strategySharpe.toFixed(2);
        document.getElementById('stat-buyhold-sharpe').textContent = stats.buyholdSharpe.toFixed(2);
        document.getElementById('stat-strategy-maxdd').textContent = stats.strategyMaxDD.toFixed(1) + '%';
        document.getElementById('stat-buyhold-maxdd').textContent = stats.buyholdMaxDD.toFixed(1) + '%';
        document.getElementById('stat-strategy-vol').textContent = stats.strategyVol.toFixed(1) + '%';
        document.getElementById('stat-position-changes').textContent = stats.positionChanges;
        document.getElementById('stat-final-value').textContent = '$' + stats.finalValue.toLocaleString(undefined, {maximumFractionDigits: 0});
        document.getElementById('stat-final-value-label').textContent = 'Final Value ($' + stats.startValue.toLocaleString(undefined, {maximumFractionDigits: 0}) + ' start)';

        // Update position distribution
        ['overweight', 'neutral', 'underweight', 'short'].forEach(pos => {
            const key = pos.charAt(0).toUpperCase() + pos.slice(1);
            const pct = stats.positionPcts[key] || 0;
            document.getElementById('pos-bar-' + pos).style.width = pct + '%';
            document.getElementById('pos-pct-' + pos).textContent = pct.toFixed(1) + '%';
        });
    }

    // Calculate statistics for multi-asset data (inverse vol / vol chase)
    function calculateMultiAssetStats(data) {
        if (!data || data.length < 2) return null;

        const startValue = data[0].portfolio_value;
        const endValue = data[data.length - 1].portfolio_value;
        const startBuyhold = data[0].buyhold_value;
        const endBuyhold = data[data.length - 1].buyhold_value;

        // Returns
        const strategyReturn = ((endValue / startValue) - 1) * 100;
        const buyholdReturn = ((endBuyhold / startBuyhold) - 1) * 100;

        // Daily returns for volatility/sharpe
        const strategyReturns = [];
        const buyholdReturns = [];
        for (let i = 1; i < data.length; i++) {
            strategyReturns.push((data[i].portfolio_value / data[i-1].portfolio_value) - 1);
            buyholdReturns.push((data[i].buyhold_value / data[i-1].buyhold_value) - 1);
        }

        // Volatility (annualized)
        const strategyVol = stdDev(strategyReturns) * Math.sqrt(252) * 100;
        const buyholdVol = stdDev(buyholdReturns) * Math.sqrt(252) * 100;

        // Annualized return
        const tradingDays = data.length;
        const years = tradingDays / 252;
        const strategyAnnual = (Math.pow(endValue / startValue, 1/years) - 1) * 100;
        const buyholdAnnual = (Math.pow(endBuyhold / startBuyhold, 1/years) - 1) * 100;

        // Sharpe (assuming 5% risk-free)
        const strategySharpe = strategyVol > 0 ? (strategyAnnual - 5) / strategyVol : 0;
        const buyholdSharpe = buyholdVol > 0 ? (buyholdAnnual - 5) / buyholdVol : 0;

        // Max Drawdown
        const strategyMaxDD = calcMaxDrawdown(data.map(d => d.portfolio_value));
        const buyholdMaxDD = calcMaxDrawdown(data.map(d => d.buyhold_value));

        return {
            strategyReturn,
            buyholdReturn,
            strategySharpe,
            buyholdSharpe,
            strategyMaxDD,
            buyholdMaxDD,
            strategyVol,
            buyholdVol
        };
    }

    // Update multi-asset stats display
    function updateMultiAssetStats(invVolStats, volChaseStats, btcStats) {
        // Update Inverse Vol section stats
        if (invVolStats) {
            const invVolRetEl = document.getElementById('stat-invvol-return');
            if (invVolRetEl) {
                invVolRetEl.textContent = invVolStats.strategyReturn.toFixed(1) + '%';
                invVolRetEl.className = 'text-2xl font-bold ' + (invVolStats.strategyReturn >= 0 ? 'text-success' : 'text-warning');
            }
            const invVolBtcEl = document.getElementById('stat-invvol-btconly');
            if (invVolBtcEl && btcStats) {
                invVolBtcEl.textContent = btcStats.strategyReturn.toFixed(1) + '%';
                invVolBtcEl.className = 'text-2xl font-bold ' + (btcStats.strategyReturn >= 0 ? 'text-success' : 'text-warning');
            }
            const invVolSharpeEl = document.getElementById('stat-invvol-sharpe');
            if (invVolSharpeEl) invVolSharpeEl.textContent = invVolStats.strategySharpe.toFixed(2);
            const invVolMaxddEl = document.getElementById('stat-invvol-maxdd');
            if (invVolMaxddEl) invVolMaxddEl.textContent = invVolStats.strategyMaxDD.toFixed(1) + '%';
        }

        // Update Vol Chase section stats
        if (volChaseStats) {
            const volChaseRetEl = document.getElementById('stat-volchase-return');
            if (volChaseRetEl) {
                volChaseRetEl.textContent = volChaseStats.strategyReturn.toFixed(1) + '%';
                volChaseRetEl.className = 'text-2xl font-bold ' + (volChaseStats.strategyReturn >= 0 ? 'text-success' : 'text-warning');
            }
            const volChaseInvVolEl = document.getElementById('stat-volchase-invvol');
            if (volChaseInvVolEl && invVolStats) {
                volChaseInvVolEl.textContent = invVolStats.strategyReturn.toFixed(1) + '%';
                volChaseInvVolEl.className = 'text-2xl font-bold ' + (invVolStats.strategyReturn >= 0 ? 'text-success' : 'text-warning');
            }
            const volChaseSharpeEl = document.getElementById('stat-volchase-sharpe');
            if (volChaseSharpeEl) volChaseSharpeEl.textContent = volChaseStats.strategySharpe.toFixed(2);
            const volChaseMaxddEl = document.getElementById('stat-volchase-maxdd');
            if (volChaseMaxddEl) volChaseMaxddEl.textContent = volChaseStats.strategyMaxDD.toFixed(1) + '%';
        }

        // Update summary comparison table
        if (btcStats) {
            updateTableCell('tbl-btc-return', btcStats.strategyReturn, true);
            updateTableCell('tbl-btc-sharpe', btcStats.strategySharpe, false, 2);
            updateTableCell('tbl-btc-maxdd', btcStats.strategyMaxDD, true);
            updateTableCell('tbl-btc-vol', btcStats.strategyVol, true);
            updateTableCell('tbl-bh-return', btcStats.buyholdReturn, true);
            updateTableCell('tbl-bh-sharpe', btcStats.buyholdSharpe, false, 2);
            updateTableCell('tbl-bh-maxdd', btcStats.buyholdMaxDD, true);
            updateTableCell('tbl-bh-vol', btcStats.buyholdVol, true);
        }
        if (invVolStats) {
            updateTableCell('tbl-invvol-return', invVolStats.strategyReturn, true);
            updateTableCell('tbl-invvol-sharpe', invVolStats.strategySharpe, false, 2);
            updateTableCell('tbl-invvol-maxdd', invVolStats.strategyMaxDD, true);
            updateTableCell('tbl-invvol-vol', invVolStats.strategyVol, true);
        }
        if (volChaseStats) {
            updateTableCell('tbl-volchase-return', volChaseStats.strategyReturn, true);
            updateTableCell('tbl-volchase-sharpe', volChaseStats.strategySharpe, false, 2);
            updateTableCell('tbl-volchase-maxdd', volChaseStats.strategyMaxDD, true);
            updateTableCell('tbl-volchase-vol', volChaseStats.strategyVol, true);
        }

        // Update top summary section
        if (btcStats) {
            updateSummaryCell('summary-btc-pnl', btcStats.strategyReturn);
            document.getElementById('summary-btc-sharpe').textContent = btcStats.strategySharpe.toFixed(2);
            updateSummaryCell('summary-bh-pnl', btcStats.buyholdReturn);
            document.getElementById('summary-bh-sharpe').textContent = btcStats.buyholdSharpe.toFixed(2);
        }
        if (invVolStats) {
            updateSummaryCell('summary-invvol-pnl', invVolStats.strategyReturn);
            document.getElementById('summary-invvol-sharpe').textContent = invVolStats.strategySharpe.toFixed(2);
        }
        if (volChaseStats) {
            updateSummaryCell('summary-volchase-pnl', volChaseStats.strategyReturn);
            document.getElementById('summary-volchase-sharpe').textContent = volChaseStats.strategySharpe.toFixed(2);
        }
    }

    // Helper to update summary P/L cells with color
    function updateSummaryCell(id, value) {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = value.toFixed(1) + '%';
        el.className = el.className.replace(/text-(success|warning)/g, '').trim();
        el.className += value >= 0 ? ' text-success' : ' text-warning';
    }

    // Helper to update table cells
    function updateTableCell(id, value, isPct, decimals = 1) {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = value.toFixed(decimals) + (isPct ? '%' : '');
        // Update color class for return columns
        if (id.includes('-return')) {
            el.className = el.className.replace(/text-(success|warning)/g, '').trim();
            el.className += value >= 0 ? ' text-success' : ' text-warning';
        }
    }

    // Create BTC chart
    function createBtcChart(data) {
        const btcCtx = document.getElementById('btcChart').getContext('2d');

        if (btcChart) btcChart.destroy();

        btcChart = new Chart(btcCtx, {
            type: 'line',
            data: {
                labels: data.map(d => d.date),
                datasets: [
                    {
                        label: 'BTC Price',
                        data: data.map(d => d.btc_price),
                        borderColor: '#D4A857',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        tension: 0.1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'EMA',
                        data: data.map(d => d.ema),
                        borderColor: '#6B7280',
                        backgroundColor: 'transparent',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0,
                        tension: 0.1,
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: document.documentElement.classList.contains('dark') ? '#fff' : '#374151' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const idx = context.dataIndex;
                                const position = data[idx].position;
                                if (context.dataset.label === 'BTC Price') {
                                    return 'BTC: $' + context.parsed.y.toLocaleString() + ' (' + position + ')';
                                }
                                return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'category',
                        ticks: { maxTicksLimit: 12, color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280' },
                        grid: { display: false }
                    },
                    y: {
                        type: 'logarithmic',
                        position: 'left',
                        ticks: {
                            callback: function(value) { return '$' + value.toLocaleString(); },
                            color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280'
                        },
                        grid: { color: document.documentElement.classList.contains('dark') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                    }
                }
            },
            plugins: [{
                id: 'customBackground',
                beforeDraw: function(chart) {
                    const ctx = chart.ctx;
                    const chartArea = chart.chartArea;
                    const xAxis = chart.scales.x;
                    let currentPos = null;
                    let startX = null;

                    data.forEach((d, idx) => {
                        const x = xAxis.getPixelForValue(d.date);
                        if (d.position !== currentPos) {
                            if (currentPos !== null && startX !== null) {
                                ctx.fillStyle = positionColors[currentPos];
                                ctx.fillRect(startX, chartArea.top, x - startX, chartArea.bottom - chartArea.top);
                            }
                            currentPos = d.position;
                            startX = x;
                        }
                    });
                    if (currentPos !== null && startX !== null) {
                        ctx.fillStyle = positionColors[currentPos];
                        ctx.fillRect(startX, chartArea.top, chartArea.right - startX, chartArea.bottom - chartArea.top);
                    }
                }
            }]
        });
    }

    // Create Equity chart with all 4 strategies (normalized to start at same point)
    function createEquityChart(btcData, invVolData, volChaseData) {
        const equityCtx = document.getElementById('equityChart').getContext('2d');

        if (equityChart) equityChart.destroy();

        // Use BTC data for dates and buy & hold baseline
        const labels = btcData.map(d => d.date);

        // Normalize all curves to start at 10000 for fair comparison
        const startBtc = btcData[0].portfolio_value;
        const startBuyhold = btcData[0].buyhold_value;
        const normalizedBtc = btcData.map(d => (d.portfolio_value / startBtc) * 10000);
        const normalizedBuyhold = btcData.map(d => (d.buyhold_value / startBuyhold) * 10000);

        // Build datasets array
        const datasets = [
            {
                label: 'BTC-Only',
                data: normalizedBtc,
                borderColor: '#D4A857',
                backgroundColor: 'transparent',
                borderWidth: 2,
                fill: false,
                pointRadius: 0,
                tension: 0.1
            },
            {
                label: 'Buy & Hold',
                data: normalizedBuyhold,
                borderColor: '#6B7280',
                backgroundColor: 'transparent',
                borderWidth: 1.5,
                fill: false,
                pointRadius: 0,
                tension: 0.1
            }
        ];

        // Add Inverse Vol if available
        if (invVolData && invVolData.length > 0) {
            const startInvVol = invVolData[0].portfolio_value;
            // Sample to match BTC data length if needed
            const invVolNormalized = invVolData.map(d => (d.portfolio_value / startInvVol) * 10000);
            datasets.push({
                label: 'Inverse Vol',
                data: invVolNormalized,
                borderColor: '#F59E0B',
                backgroundColor: 'transparent',
                borderWidth: 2,
                fill: false,
                pointRadius: 0,
                tension: 0.1
            });
        }

        // Add Vol Chase if available
        if (volChaseData && volChaseData.length > 0) {
            const startVolChase = volChaseData[0].portfolio_value;
            const volChaseNormalized = volChaseData.map(d => (d.portfolio_value / startVolChase) * 10000);
            datasets.push({
                label: 'Vol Chase',
                data: volChaseNormalized,
                borderColor: '#A855F7',
                backgroundColor: 'transparent',
                borderWidth: 2,
                fill: false,
                pointRadius: 0,
                tension: 0.1
            });
        }

        equityChart = new Chart(equityCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: document.documentElement.classList.contains('dark') ? '#fff' : '#374151' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'category',
                        ticks: { maxTicksLimit: 12, color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280' },
                        grid: { display: false }
                    },
                    y: {
                        type: 'logarithmic',
                        ticks: {
                            callback: function(value) { return '$' + value.toLocaleString(); },
                            color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280'
                        },
                        grid: { color: document.documentElement.classList.contains('dark') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                    }
                }
            }
        });
    }

    // Create Inverse Vol Equity chart
    function createInvVolEquityChart(data) {
        if (!data || data.length < 2) return;

        const ctx = document.getElementById('invVolEquityChart');
        if (!ctx) return;

        if (invVolEquityChart) invVolEquityChart.destroy();

        // Sample data for performance
        const sampled = data.filter((d, i) => i % 5 === 0 || i === data.length - 1);

        // Normalize to start at 10000
        const startStrategy = sampled[0].portfolio_value;
        const startBuyhold = sampled[0].buyhold_value;

        invVolEquityChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: sampled.map(d => d.date),
                datasets: [
                    {
                        label: 'Inverse Vol Strategy',
                        data: sampled.map(d => (d.portfolio_value / startStrategy) * 10000),
                        borderColor: '#F59E0B',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    },
                    {
                        label: 'BTC Buy & Hold',
                        data: sampled.map(d => (d.buyhold_value / startBuyhold) * 10000),
                        borderColor: '#6B7280',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: document.documentElement.classList.contains('dark') ? '#fff' : '#374151' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y.toLocaleString(undefined, {maximumFractionDigits: 0});
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'category',
                        ticks: { maxTicksLimit: 8, color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280' },
                        grid: { display: false }
                    },
                    y: {
                        type: 'logarithmic',
                        ticks: {
                            callback: function(value) { return '$' + value.toLocaleString(); },
                            color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280'
                        },
                        grid: { color: document.documentElement.classList.contains('dark') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                    }
                }
            }
        });
    }

    // Create Vol Chase Equity chart
    function createVolChaseEquityChart(data) {
        if (!data || data.length < 2) return;

        const ctx = document.getElementById('volChaseEquityChart');
        if (!ctx) return;

        if (volChaseEquityChart) volChaseEquityChart.destroy();

        // Sample data for performance
        const sampled = data.filter((d, i) => i % 5 === 0 || i === data.length - 1);

        // Normalize to start at 10000
        const startStrategy = sampled[0].portfolio_value;
        const startBuyhold = sampled[0].buyhold_value;

        volChaseEquityChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: sampled.map(d => d.date),
                datasets: [
                    {
                        label: 'Vol Chase Strategy',
                        data: sampled.map(d => (d.portfolio_value / startStrategy) * 10000),
                        borderColor: '#A855F7',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    },
                    {
                        label: 'BTC Buy & Hold',
                        data: sampled.map(d => (d.buyhold_value / startBuyhold) * 10000),
                        borderColor: '#6B7280',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: document.documentElement.classList.contains('dark') ? '#fff' : '#374151' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y.toLocaleString(undefined, {maximumFractionDigits: 0});
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'category',
                        ticks: { maxTicksLimit: 8, color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280' },
                        grid: { display: false }
                    },
                    y: {
                        type: 'logarithmic',
                        ticks: {
                            callback: function(value) { return '$' + value.toLocaleString(); },
                            color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280'
                        },
                        grid: { color: document.documentElement.classList.contains('dark') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                    }
                }
            }
        });
    }

    // Update everything based on selected range
    function updateForRange(range) {
        currentRange = range;

        // Update time period label FIRST (before any data processing)
        const periodLabels = {
            'all': 'All Time',
            '2y': 'Last 2 Years',
            '1y': 'Last 1 Year',
            '6m': 'Last 6 Months',
            'ytd': 'Year to Date'
        };
        const timePeriodEl = document.getElementById('summary-time-period');
        if (timePeriodEl) {
            timePeriodEl.textContent = periodLabels[range] || 'All Time';
        }

        const filteredData = filterDataByRange(fullPriceData, range);

        if (filteredData.length < 2) {
            console.warn('Not enough data for range:', range);
            return;
        }

        const stats = calculateStats(filteredData);
        updateStats(stats);
        createBtcChart(filteredData);

        // Calculate and update multi-asset stats
        let invVolStats = null;
        let volChaseStats = null;
        let filteredInvVol = null;
        let filteredVolChase = null;

        // Filter multi-asset data if available
        if (fullInvVolData) {
            filteredInvVol = filterDataByRange(fullInvVolData, range);
            if (filteredInvVol.length >= 2) {
                invVolStats = calculateMultiAssetStats(filteredInvVol);
            }
        }
        if (fullVolChaseData) {
            filteredVolChase = filterDataByRange(fullVolChaseData, range);
            if (filteredVolChase.length >= 2) {
                volChaseStats = calculateMultiAssetStats(filteredVolChase);
            }
        }

        // Create combined equity chart with all strategies
        createEquityChart(filteredData, filteredInvVol, filteredVolChase);

        // Update all multi-asset stats displays (including summary table)
        updateMultiAssetStats(invVolStats, volChaseStats, stats);

        // Update button styles
        document.querySelectorAll('#timeRangeFilter button').forEach(btn => {
            if (btn.dataset.range === range) {
                btn.className = 'px-3 py-1.5 text-sm font-medium bg-navy text-white border-l border-gray-300 dark:border-gray-600 first:border-l-0';
            } else {
                btn.className = 'px-3 py-1.5 text-sm font-medium bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 border-l border-gray-300 dark:border-gray-600 first:border-l-0';
            }
        });
    }

    // Set up button click handlers
    document.querySelectorAll('#timeRangeFilter button').forEach(btn => {
        btn.addEventListener('click', () => updateForRange(btn.dataset.range));
    });

    // Load multi-asset data BEFORE initial render
    {% if vol_data and not vol_data.error and vol_data.chart_data %}
    fullInvVolData = {{ vol_data.chart_data | tojson }};
    {% endif %}
    {% if vol_chase_data and not vol_chase_data.error and vol_chase_data.chart_data %}
    fullVolChaseData = {{ vol_chase_data.chart_data | tojson }};
    {% endif %}

    // Initial render with all data
    updateForRange('all');
    {% endif %}

    // Multi-Asset Volatility Charts
    {% if vol_data and not vol_data.error and vol_data.chart_data %}
    const volChartData = {{ vol_data.chart_data | tojson }};

    // Sample data for charts (every 5th point to reduce density)
    const sampledVolData = volChartData.filter((d, i) => i % 5 === 0 || i === volChartData.length - 1);

    // Asset Weight History Chart
    const weightCtx = document.getElementById('weightChart').getContext('2d');
    new Chart(weightCtx, {
        type: 'line',
        data: {
            labels: sampledVolData.map(d => d.date),
            datasets: [
                {
                    label: 'BTC Weight',
                    data: sampledVolData.map(d => d.btc_weight * 100),
                    borderColor: '#F7931A',
                    backgroundColor: 'rgba(247, 147, 26, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 0,
                    tension: 0.3
                },
                {
                    label: 'ETH Weight',
                    data: sampledVolData.map(d => d.eth_weight * 100),
                    borderColor: '#627EEA',
                    backgroundColor: 'rgba(98, 126, 234, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 0,
                    tension: 0.3
                },
                {
                    label: 'SOL Weight',
                    data: sampledVolData.map(d => d.sol_weight * 100),
                    borderColor: '#00FFA3',
                    backgroundColor: 'rgba(0, 255, 163, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 0,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: document.documentElement.classList.contains('dark') ? '#fff' : '#374151' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'category',
                    ticks: { maxTicksLimit: 10, color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280' },
                    grid: { display: false }
                },
                y: {
                    min: 0,
                    max: 100,
                    ticks: {
                        callback: function(value) { return value + '%'; },
                        color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280'
                    },
                    grid: { color: document.documentElement.classList.contains('dark') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                }
            }
        }
    });

    // Volatility History Chart
    const volHistCtx = document.getElementById('volChart').getContext('2d');
    new Chart(volHistCtx, {
        type: 'line',
        data: {
            labels: sampledVolData.map(d => d.date),
            datasets: [
                {
                    label: 'BTC Vol',
                    data: sampledVolData.map(d => d.btc_vol),
                    borderColor: '#F7931A',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.3
                },
                {
                    label: 'ETH Vol',
                    data: sampledVolData.map(d => d.eth_vol),
                    borderColor: '#627EEA',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.3
                },
                {
                    label: 'SOL Vol',
                    data: sampledVolData.map(d => d.sol_vol),
                    borderColor: '#00FFA3',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: document.documentElement.classList.contains('dark') ? '#fff' : '#374151' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(0) + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'category',
                    ticks: { maxTicksLimit: 10, color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280' },
                    grid: { display: false }
                },
                y: {
                    ticks: {
                        callback: function(value) { return value + '%'; },
                        color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280'
                    },
                    grid: { color: document.documentElement.classList.contains('dark') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                }
            }
        }
    });
    {% endif %}

    // Vol Chase Charts
    {% if vol_chase_data and not vol_chase_data.error and vol_chase_data.chart_data %}
    const volChaseChartData = {{ vol_chase_data.chart_data | tojson }};
    const sampledVolChaseData = volChaseChartData.filter((d, i) => i % 5 === 0 || i === volChaseChartData.length - 1);

    // Vol Chase Weight History Chart
    const volChaseWeightCtx = document.getElementById('volChaseWeightChart').getContext('2d');
    new Chart(volChaseWeightCtx, {
        type: 'line',
        data: {
            labels: sampledVolChaseData.map(d => d.date),
            datasets: [
                {
                    label: 'BTC Weight',
                    data: sampledVolChaseData.map(d => d.btc_weight * 100),
                    borderColor: '#F7931A',
                    backgroundColor: 'rgba(247, 147, 26, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 0,
                    tension: 0.3
                },
                {
                    label: 'ETH Weight',
                    data: sampledVolChaseData.map(d => d.eth_weight * 100),
                    borderColor: '#627EEA',
                    backgroundColor: 'rgba(98, 126, 234, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 0,
                    tension: 0.3
                },
                {
                    label: 'SOL Weight',
                    data: sampledVolChaseData.map(d => d.sol_weight * 100),
                    borderColor: '#00FFA3',
                    backgroundColor: 'rgba(0, 255, 163, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 0,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: document.documentElement.classList.contains('dark') ? '#fff' : '#374151' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'category',
                    ticks: { maxTicksLimit: 10, color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280' },
                    grid: { display: false }
                },
                y: {
                    min: 0,
                    max: 100,
                    ticks: {
                        callback: function(value) { return value + '%'; },
                        color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280'
                    },
                    grid: { color: document.documentElement.classList.contains('dark') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                }
            }
        }
    });
    {% endif %}

});
</script>
{% endblock %}
